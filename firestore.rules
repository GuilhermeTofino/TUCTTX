rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // =========================================================================
    // ENVIRONMENTS ROOT (Separation of DEV vs PROD)
    // =========================================================================
    match /environments/{env} {
      // Validate env is 'dev' or 'prod' if needed, or just allow wildcard.
      
      match /tenants/{tenantId} {
        // 1. Tenant Configuration
        // Public read access allowed for the app to load theme/config before login.
        allow read: if true;
        
        // -----------------------------------------------------------------------
        // USERS SUBCOLLECTION
        // Path: /environments/{env}/tenants/{tenantId}/users/{userId}
        // -----------------------------------------------------------------------
        match /users/{userId} {
          allow read: if request.auth != null;
          allow create: if request.auth != null; 
          allow update: if request.auth != null && (request.auth.uid == userId || 
            get(/databases/$(database)/documents/environments/$(env)/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin');
          allow delete: if request.auth != null && request.auth.uid == userId; 
        }
        
        // -----------------------------------------------------------------------
        // MENUS SUBCOLLECTION
        // Path: .../menus/{menuId}
        // -----------------------------------------------------------------------
        match /menus/{menuId} {
          allow read: if request.auth != null;
          allow write: if request.auth != null && 
            get(/databases/$(database)/documents/environments/$(env)/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
        }

        // -----------------------------------------------------------------------
        // ANNOUNCEMENTS SUBCOLLECTION
        // Path: .../announcements/{announcementId}
        // -----------------------------------------------------------------------
        match /announcements/{announcementId} {
          allow read: if request.auth != null;
          allow write: if request.auth != null && 
            get(/databases/$(database)/documents/environments/$(env)/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
        }

        // -----------------------------------------------------------------------
        // FINANCIAL SUBCOLLECTION
        // Path: .../financial/{userId}
        // -----------------------------------------------------------------------
        match /financial/{userId} {
          allow read: if request.auth != null && (request.auth.uid == userId || 
            get(/databases/$(database)/documents/environments/$(env)/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin');
          
          match /monthly_fees/{feeId} {
            allow read: if request.auth != null && (request.auth.uid == userId || 
              get(/databases/$(database)/documents/environments/$(env)/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin');
            allow write: if request.auth != null && 
              get(/databases/$(database)/documents/environments/$(env)/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
          }

          match /bazaar_debts/{debtId} {
            allow read: if request.auth != null && (request.auth.uid == userId || 
              get(/databases/$(database)/documents/environments/$(env)/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin');
            allow write: if request.auth != null && 
              get(/databases/$(database)/documents/environments/$(env)/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
          }
        }

        // -----------------------------------------------------------------------
        // FINANCIAL GOALS SUBCOLLECTION
        // Path: .../financial_goals/{goalId}
        // -----------------------------------------------------------------------
        match /financial_goals/{goalId} {
          allow read, write: if request.auth != null && 
            get(/databases/$(database)/documents/environments/$(env)/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
        }

        // -----------------------------------------------------------------------
        // EVENTS SUBCOLLECTION
        // Path: .../events/{eventId}
        // -----------------------------------------------------------------------
        match /events/{eventId} {
          allow read: if request.auth != null;
          allow write: if request.auth != null && 
            get(/databases/$(database)/documents/environments/$(env)/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
          
          match /confirmations/{userId} {
            allow read: if request.auth != null;
            allow write: if request.auth != null && request.auth.uid == userId;
          }
        }

        // -----------------------------------------------------------------------
        // STUDIES SUBCOLLECTION
        // Path: .../studies/{docId}
        // -----------------------------------------------------------------------
        match /studies/{docId} {
          allow read: if request.auth != null;
          allow write: if request.auth != null && 
            get(/databases/$(database)/documents/environments/$(env)/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
        }
        // -----------------------------------------------------------------------
        // CAMBONE SCHEDULES SUBCOLLECTION
        // Path: .../cambone_schedules/{scheduleId}
        // -----------------------------------------------------------------------
        match /cambone_schedules/{scheduleId} {
          allow read: if true;
          allow write: if request.auth != null && 
            get(/databases/$(database)/documents/environments/$(env)/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
        }
      }
    }
    
    // =========================================================================
    // LEGACY / DEPRECATED PATHS
    // =========================================================================
    // Blocking access to root /events to ensure data consistency with the new structure.
    match /events/{eventId} {
      allow read, write: if false;
    }

    // -----------------------------------------------------------------------
    // NOTIFICATIONS QUEUE (Triggers for Cloud Functions)
    // -----------------------------------------------------------------------
    match /notifications_queue/{docId} {
      // Permite criar apenas se o usuário estiver logado e for admin no tenant/env especificado
      allow create: if request.auth != null && 
        get(/databases/$(database)/documents/environments/$(request.resource.data.env)/tenants/$(request.resource.data.tenantId)/users/$(request.auth.uid)).data.role == 'admin';
      
      // Proíbe leitura, update ou delete pelo app (apenas Cloud Functions devem gerenciar)
      allow read, update, delete: if false;
    }
  }
}
