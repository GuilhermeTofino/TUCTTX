rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // =========================================================================
    // ENVIRONMENTS ROOT (Separation of DEV vs PROD)
    // =========================================================================
    match /environments/{env} {
      // Validate env is 'dev' or 'prod' if needed, or just allow wildcard.
      
      match /tenants/{tenantId} {
        // 1. Tenant Configuration
        // Public read access allowed for the app to load theme/config before login.
        allow read: if true;
        
        // -----------------------------------------------------------------------
        // USERS SUBCOLLECTION
        // Path: /environments/{env}/tenants/{tenantId}/users/{userId}
        // -----------------------------------------------------------------------
        match /users/{userId} {
          allow read: if request.auth != null;
          allow create: if request.auth != null; 
          allow update: if request.auth != null && request.auth.uid == userId;
          allow delete: if false; 
        }
        
        // -----------------------------------------------------------------------
        // MENUS SUBCOLLECTION
        // Path: .../menus/{menuId}
        // -----------------------------------------------------------------------
        match /menus/{menuId} {
          allow read: if request.auth != null;
          allow write: if false; 
        }

        // -----------------------------------------------------------------------
        // EVENTS SUBCOLLECTION
        // Path: .../events/{eventId}
        // -----------------------------------------------------------------------
        match /events/{eventId} {
          allow read: if request.auth != null;
          allow write: if request.auth != null;
          
          match /confirmations/{userId} {
            allow read: if request.auth != null;
            allow write: if request.auth != null && request.auth.uid == userId;
          }
        }
      }
    }
    
    // =========================================================================
    // LEGACY / DEPRECATED PATHS
    // =========================================================================
    // Blocking access to root /events to ensure data consistency with the new structure.
    match /events/{eventId} {
      allow read, write: if false;
    }
  }
}
